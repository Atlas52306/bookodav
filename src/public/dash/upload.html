<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yohns/picocss@2.2.10/css/pico.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/dav/styles.css">
  <title>BOOKO-DAV - 上传</title>
</head>

<body>
  <header class="container">
    <nav>
      <ul class="contrast">
        <li><strong><i class="fas fa-book"></i> BOOKO-DAV</strong></li>
      </ul>
      <ul>
        <li><a href="/dav"><i class="fas fa-book-open"></i> 使用指南</a></li>
        <li><a href="/dav/upload" class="nav-button"><i class="fas fa-upload"></i> 上传</a></li>
        <li><a href="/dav/list"><i class="fas fa-list"></i> 查看文档</a></li>
      </ul>
    </nav>
  </header>

  <main class="container">
    <section>
      <h2><i class="fas fa-cloud-upload-alt"></i> 上传文件</h2>
      <div class="feature-card">
        <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
          <label for="files"><i class="fas fa-file-alt"></i> 选择要上传的文件：</label>
          <input type="file" id="files" name="files" required multiple
            accept=".epub,.pdf,.mobi,.cbr,.cbz,.jpg,.jpeg,.png,.gif,.webp">
          <button type="submit" id="uploadButton"><i class="fas fa-cloud-upload-alt"></i> 上传</button>
        </form>
        <div id="uploadStatus"></div>
      </div>
    </section>
    
    <footer class="footer">
      <span>
        <span id="year"></span> &copy; Atlas
      </span>
    </footer>
  </main>
  
  <script>
    const yearElement = document.querySelector("#year")
    const year = new Date().getFullYear()
    yearElement.innerHTML = year
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('uploadForm');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadButton = document.getElementById('uploadButton');
      const fileInput = document.getElementById('files');

      // 服务器配置中允许的文件类型
      const allowedTypes = ['epub', 'pdf', 'mobi', 'cbr', 'cbz',
        'jpg', 'jpeg', 'png', 'gif', 'webp'];

      // 最大文件大小（100MB）
      const MAX_FILE_SIZE = 100 * 1024 * 1024;

      function showError(message) {
        uploadStatus.innerHTML = `<div class="error" role="alert">${message}</div>`;
        uploadStatus.scrollIntoView({ behavior: 'smooth' });
      }

      function validateFiles(files) {
        const errors = [];
        const seenNames = new Set();

        if (files.length === 0) {
          errors.push('未选择文件');
          return errors;
        }

        for (const file of files) {
          // 文件类型验证
        //  const extension = file.name.split('.').pop().toLowerCase();
         // if (!allowedTypes.includes(extension)) {
           // errors.push(`无效的文件类型: ${file.name} (${extension})`);
         // }

          // 文件大小验证
          if (file.size > MAX_FILE_SIZE) {
            errors.push(`文件过大: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
          }

          // 空文件检查
          if (file.size === 0) {
            errors.push(`空文件: ${file.name}`);
          }

          // 重复名称检查
          if (seenNames.has(file.name)) {
            errors.push(`重复的文件名: ${file.name}`);
          }
          seenNames.add(file.name);
        }

        return errors;
      }

      uploadButton.addEventListener('click', async function (e) {
        e.preventDefault();
        uploadStatus.innerHTML = '';

        const files = Array.from(fileInput.files);
        const validationErrors = validateFiles(files);

        if (validationErrors.length > 0) {
          showError(validationErrors.join('<br>'));
          return;
        }

        // 上传期间禁用按钮
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';

        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (!response.ok) throw new Error('服务器错误');

          // 显示带样式的结果
          const success = data.filter(item => item.status === 'success');
          const failures = data.filter(item => item.status === 'failed');

          let resultHtml = `<div class="success" role="status">
                              <span><i class="fas fa-check-circle"></i> 成功上传 ${success.length} 个文件:</span>
                              <ul>${success.map(f => `<li>${f.sanitizedFilename}</li>`).join('')}</ul>`;

          if (failures.length > 0) {
            resultHtml += `<div class="error" role="alert">
                             <p><i class="fas fa-exclamation-triangle"></i> 上传失败 ${failures.length} 个文件:</p>
                             <ul>${failures.map(f => `<li>${f.filename}: ${f.error}</li>`).join('')}</ul>
                             </div>`;
          }

          uploadStatus.innerHTML = resultHtml;

          // 成功时清除表单
          if (failures.length === 0) fileInput.value = '';

          // 刷新文件列表
          await fetch('/dash/list', { headers: { 'Cache-Control': 'no-cache' } });

        } catch (error) {
          showError(`<i class="fas fa-exclamation-circle"></i> 上传失败: ${error.message}`);
        } finally {
          uploadButton.disabled = false;
          uploadButton.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 上传';
        }
      });

      // 文件选择的视觉反馈
      fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
          uploadStatus.innerHTML = `<div class="info"><i class="fas fa-info-circle"></i> 已选择 ${this.files.length} 个文件</div>`;
        }
      });
    });
  </script>
</body>

</html>
