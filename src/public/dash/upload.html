<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yohns/picocss@2.2.10/css/pico.min.css">
  <style>
    .error {
      color: #dc3545;
      padding: 1rem;
      border: 1px solid #dc3545;
      border-radius: 4px;
      margin: 1rem 0;

      ul {
        color: var(--pico-contrast-inverse);
      }
    }

    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .w3c {
      width: 64px;
    }

    .success {
      color: var(--pico-primary);
      padding: 1rem;
      border: 1px solid #28a745;
      border-radius: 4px;
      margin: 1rem 0;

      ul {
        color: var(--pico-contrast-inverse);
      }
    }

    .info {
      color: #17a2b8;
      padding: 0.5rem;
      margin: 0.5rem 0;

      ul {
        color: var(--pico-contrast-inverse);
      }
    }

    [role="alert"] {
      background-color: #f8d7da;
    }

    [role="status"] {
      background-color: #d4edda;
    }
  </style>
  <title>BOOKO-DAV - 上传</title>
</head>

<body>
  <main class="container">
    <header class="container">
      <nav>
        <ul class="contrast">
          <li><strong>BOOKO-DAV</strong></li>
        </ul>
        <ul>
          <li><a href="/dav">使用指南</a></li>
          <li><a href="/dav/upload">上传</a></li>
          <li><a href="/dav/list">查看文档</a></li>
        </ul>
      </nav>
    </header>
    <section>
      <h2>上传文件</h2>
      <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <label for="files">选择要上传的文件：</label>
        <input type="file" id="files" name="files" required multiple
          accept=".epub,.pdf,.mobi,.cbr,.cbz,.jpg,.jpeg,.png,.gif,.webp">
        <!-- 使用type="button"防止原生提交 -->
        <button type="submit" id="uploadButton">上传</button>
      </form>
      <div id="uploadStatus"></div>
    </section>
    <footer class="footer">
      <span>
        <span id="year"></span> &copy; Atlas

      </span>
    </footer>
  </main>
  <script>
    const yearElement = document.querySelector("#year")
    const year = new Date().getFullYear()
    yearElement.innerHTML = year
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('uploadForm');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadButton = document.getElementById('uploadButton');
      const fileInput = document.getElementById('files');

      // 服务器配置中允许的文件类型
      const allowedTypes = ['epub', 'pdf', 'mobi', 'cbr', 'cbz',
        'jpg', 'jpeg', 'png', 'gif', 'webp'];

      // 最大文件大小（100MB）
      const MAX_FILE_SIZE = 100 * 1024 * 1024;

      function showError(message) {
        uploadStatus.innerHTML = `<div class="error" role="alert">${message}</div>`;
        uploadStatus.scrollIntoView({ behavior: 'smooth' });
      }

      function validateFiles(files) {
        const errors = [];
        const seenNames = new Set();

        if (files.length === 0) {
          errors.push('未选择文件');
          return errors;
        }

        for (const file of files) {
          // 文件类型验证
        //  const extension = file.name.split('.').pop().toLowerCase();
         // if (!allowedTypes.includes(extension)) {
           // errors.push(`无效的文件类型: ${file.name} (${extension})`);
         // }

          // 文件大小验证
          if (file.size > MAX_FILE_SIZE) {
            errors.push(`文件过大: ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
          }

          // 空文件检查
          if (file.size === 0) {
            errors.push(`空文件: ${file.name}`);
          }

          // 重复名称检查
          if (seenNames.has(file.name)) {
            errors.push(`重复的文件名: ${file.name}`);
          }
          seenNames.add(file.name);
        }

        return errors;
      }

      uploadButton.addEventListener('click', async function (e) {
        e.preventDefault();
        uploadStatus.innerHTML = '';

        const files = Array.from(fileInput.files);
        const validationErrors = validateFiles(files);

        if (validationErrors.length > 0) {
          showError(validationErrors.join('<br>'));
          return;
        }

        // 上传期间禁用按钮
        uploadButton.disabled = true;
        uploadButton.textContent = '上传中...';

        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (!response.ok) throw new Error('服务器错误');

          // 显示带样式的结果
          const success = data.filter(item => item.status === 'success');
          const failures = data.filter(item => item.status === 'failed');

          let resultHtml = `<div class="success" role="status">
                              <span>成功上传 ${success.length} 个文件:</span>
                              <ul>${success.map(f => `<li>${f.sanitizedFilename}</li>`).join('')}</ul>`;

          if (failures.length > 0) {
            resultHtml += `<div class="error" role="alert">
                             <p>上传失败 ${failures.length} 个文件:</p>
                             <ul>${failures.map(f => `<li>${f.filename}: ${f.error}</li>`).join('')}</ul>
                             </div>`;
          }

          uploadStatus.innerHTML = resultHtml;

          // 成功时清除表单
          if (failures.length === 0) fileInput.value = '';

          // 刷新文件列表
          await fetch('/dash/list', { headers: { 'Cache-Control': 'no-cache' } });

        } catch (error) {
          showError(`上传失败: ${error.message}`);
        } finally {
          uploadButton.disabled = false;
          uploadButton.textContent = '上传';
        }
      });

      // 文件选择的视觉反馈
      fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
          uploadStatus.innerHTML = `<div class="info">已选择 ${this.files.length} 个文件</div>`;
        }
      });
    });
  </script>
</body>

</html>
